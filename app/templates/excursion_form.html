{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}

<section class="content-header">
  <h4><i class="fas fa-edit"></i> <b>Send a new request for the organization of excursion</b></h4>
</section>

<form id="application_form" action="send_blank/" method="post" class="card">
	{% csrf_token %}
	<div class="row">
		<div class="col">
				{{ form.facility|as_crispy_field }}
		</div>
		<div class="col">
      <label for="id_id_facility" class="col-form-label  requiredField">
		      Select areas:<span class="asteriskField">*</span>
  		</label>
				{{ form.areas|safe }}
		</div>
		<div class="col align-self-center">
				<label id="id_incharge"></label><br>
		</div>
        <div class="col">
			{{ form.guide|as_crispy_field }}
		</div>
	</div>
	<div class="row">
        <div class="col">
			{{ form.occasion|as_crispy_field }}
		</div>
    </div>
	<div class="row">
      <div class="col">
			   {{ form.date|as_crispy_field }}
      </div>
      <div class="col">
        <div class="input-group clockpicker" data-placement="bottom" data-align="top" data-autoclose="true">
  			     {{ form.start_time|as_crispy_field }}
        </div>
  		</div>
      <div class="col">
        <div class="input-group clockpicker" data-placement="bottom" data-align="top" data-autoclose="true">
            {{ form.stop_time|as_crispy_field }}
        </div>
  		</div>
  </div>
	<div class="row">
        <div class="col">
			{{ form.language|as_crispy_field }}
		</div>
    </div>
	<div class="row">
        <div class="col">
			{{ form.auditory|as_crispy_field }}
		</div>
    </div>
	<div class="row">
        <div class="col">
			{{ form.participants|as_crispy_field }}
		</div>
    </div>
	<input type="submit" style="display: none;"/>
</form>
<button id="bt_change" class="btn btn-block btn-warning" data-toggle="modal" data-target="#myModal">SEND</button>

<!-- MODAL FOR CONFIRMATION -->
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header" style="padding:25px 50px; background-color: #f0ad4e;">
          <h4>
          	<span class="glyphicon glyphicon-bell"></span> Are you sure you want to send a request for this excursion?
          </h4>
        </div>
        <div class="modal-body" style="padding:40px 50px;">
              <label><span class="glyphicon glyphicon-edit"></span> The status of the excursion will be set to "UNCONFIRMED" until the responsible person and the guide approve it.</label>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger btn-default pull-left" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> Cancel</button>
          <button id="modal_submit" type="submit" class="btn btn-success" onclick="submit_changes()"><span class="glyphicon glyphicon-ok"></span> Yes, I'm sure</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script type="text/javascript">
	$(document).ready(function() {
		$('#id_areas li').each(function () {
			$(this).hide();
		});

		$("select").addClass("form-control select2 select2-hidden-accessible");
		$('#id_date').datepicker({
      format: 'yyyy-mm-dd',
		});
    $('.clockpicker').clockpicker();
	});

    $("#id_facility").change(function() {

          var id_facility = $(this).val();

          if (id_facility !== ''){
          	$.ajax ({
	            url: "get_areas/",
	            type: "post",
	            data: {
	            	csrfmiddlewaretoken: getCookie('csrftoken'),
	                'facility': id_facility,
	            },
	            success: function(data) {
	            	// set all checkboxes.checked = false
	            	$('#id_areas li label input').each(function () {
				        $(this).prop('checked', false);
				    });

	            	// if current area doesn't belong to current facility then hide its label
	            	// else show it
	            	$('#id_areas li').each(function () {
    					    var str = $.trim($(this).text());
      						if (!data['areas'].includes(str)) {
      							$(this).hide();
      						}
      						else $(this).show();
      					});

	            	//$('#id_incharge option').each(function(){
	            	//	var id_incharge = $(this).val();
		            //	if (data['id_incharge']==id_incharge){
		            //		$(this).prop('selected', true);
		            //	}
	            	//})
					$('#id_incharge').text("Incharge: " + data['info_incharge']);
					$('#id_incharge').css('background-color', '#f0ad4e');
					$('#id_incharge').css('padding', '1%');

				},
				error: function(xhr, ajaxOptions, thrownError) {
	                console.log(xhr.status);
	                console.log(xhr.responseText);
	                console.log(thrownError);
	            },
        	});
          }
          else {
          	$.ajax ({
	            url: "get_areas/",
	            type: "post",
	            data: {
	            	csrfmiddlewaretoken: getCookie('csrftoken'),
	                'facility': 0,
	            },
	            success: function(data) {
	            	document.location.reload(true);
				},
				error: function(xhr, ajaxOptions, thrownError) {
	                console.log(xhr.status);
	                console.log(xhr.responseText);
	                console.log(thrownError);
	            },
        	});
          }
    })

    $('#bt_change').on('click', function(e){
		  $('#myModal').modal('show');
		  e.preventDefault();
	});

    function getCookie(name){
	    var cookieValue = null;
	    if (document.cookie && document.cookie !== '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
    	}
    	return cookieValue;
	}

	function submit_changes() {
		$('#myModal').modal('hide');
		$('#id_incharge').attr('disabled', false);
		$('#div_id_confirmed label input').prop('checked', true);
		$("#application_form").submit();
	};

</script>

{% endblock %}
